<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            function loadBook() {
                let params = (new URL(document.location)).searchParams;
                let id = params.get("id");
                let xhttp = new XMLHttpRequest();
                let body;
                xhttp.onreadystatechange = () =>
                {
                    if (xhttp.readyState == 4 && xhttp.status == 200) {
                        body = xhttp.response
                        var input = window.document.getElementById("title");
                        input.value = body[0].title;
                        input = window.document.getElementById("author");
                        input.value = body[0].author;
                        input = window.document.getElementById("cover");
                        input.src = `files/${id}`;
                        input = window.document.getElementById("myfile");
                    }
                }
                xhttp.open('GET', `http://localhost:3000/books/book?id=${id}`, true); //async
                xhttp.responseType = "json";
                xhttp.send();

                let form = window.document.getElementById("bookForm");
                form.addEventListener("submit", (ev) =>
                {
                    form = window. document.querySelector("form");
                    var data = new FormData(form);
                    // if (data.get("myfile").length == 0) {
                    //     //console.log(body[0].img.data);
                    //     //console.log(body[0].img.data.data);
                    //     let bits = body[0].img.data.data;//.atob();
                    //     let type = body[0].img.contentType;
                    //     let options = {
                    //         type: type
                    //     }
                    //     let file = new File(bits, `${id}`, options);
                    //     data.set("myfile", file);
                    //     //console.log(data.get("myfile").arrayBuffer().then(buffer => console.log(buffer)));
                    // }
                    
                    
                    data.append('id', `${id}`);
                    
                    let xhttp = new XMLHttpRequest();
                    xhttp.open("PUT", `http://localhost:3000/books/book`); //async
                    xhttp.onreadystatechange = function() {
                        if (xhttp.readyState == 4 && xhttp.status == 200) {
                            //console.log("livro adicionado");
                            let result = window.document.getElementById("resultSpan");
                            result.innerText = "Adicionado!";
                        }
                        else if(xhttp.readyState == 4 && xhttp.status == 400) {
                            //console.log("Erro");
                            let result = window.document.getElementById("resultSpan");
                            result.innerText = "Erro!";
                        }
                        //window.location.href = `book.html?id=${id}`; //redirect
                    };
                    xhttp.send(data);
                    ev.preventDefault();
                }, false);
            }
            window.onload = loadBook;
        </script>
    </head>
    <body>
        <div id='book'>
            <form enctype="multipart/form-data" name="formData" id="bookForm">
                <label>Title:</label>
                <input type="text" id="title" name="title" required><br>
                <label>Author:</label>
                <input type="text" id="author" name="author" required><br>
                <img id="cover"><br>
                <label for="myfile">Upload a file:</label>
                <input type="file" id="myfile" name="myfile">
                <input type="submit" value="Save"> <span id="resultSpan"></span>
                <input type="button" value="Cancel" onclick="">
            </form>
        </div>
    </body>
</html>